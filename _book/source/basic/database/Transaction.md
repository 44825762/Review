### 事务概念
##### 事务（Transaction）是指构成单一逻辑工作单元的操作集合，要么完整地执行，要么完全不执行。

1. 如果事务中有的操作没有成功完成，则事务中的所有操作都需要被回滚，回到事务执行前的状态（要么全执行，要么全都不执行）；

2. 同时，该事务对数据库或者其他事务的执行无影响，所有的事务都好像在独立的运行。

### 事务四大特性(ACID)
    
* 原子性（Atomicity）: 事务要么全部完成，要么全部取消。 如果事务崩溃，状态回到事务之前（事务回滚）。

    **原子性**，确保不管交易过程中发生了什么意外状况（服务器崩溃、网络中断等），不能出现A账户少了一个亿，但B账户没到帐，或者A账户没变，但B账户却凭空收到一个亿（数据不一致）。A和B账户的金额变动要么同时成功，要么同时失败(保持原状)。

* 隔离性（Isolation）: 如果2个事务 T1 和 T2 同时运行，事务 T1 和 T2 最终的结果是相同的，不管 T1和T2谁先结束。

    **隔离性**，如果A在转账1亿给B（T1），同时C又在转账3亿给A（T2），不管T1和T2谁先执行完毕，最终结果必须是A账户增加2亿，而不是3亿，B增加1亿，C减少3亿。

* 持久性（Durability）: 一旦事务提交，不管发生什么（崩溃或者出错），数据要保存在数据库中。

    **持久性**，确保如果 T1 刚刚提交，数据库就发生崩溃，T1执行的结果依然会保持在数据库中。

* 一致性（Consistency）: 只有合法的数据（依照关系约束和函数约束）才能写入数据库。

    **一致性**，确保钱不会在系统内凭空产生或消失， 依赖原子性和隔离性。
    
### 事务的隔离级别
如果两个事务同时对一个表进行操作，就需要给表加上互斥锁。所以，在事务中更新某条数据获得的互斥锁，只有在事务提交或失败之后才会释放，在此之前，其他事务是只能读，不能写这条数据的。
![事务的隔离级别](https://picb.zhimg.com/80/v2-59ea2f0769e4e9ffbcdce938d306fae9_1440w.png)

* Serializable (串行化)：可避免脏读、不可重复读、幻读的发生。

* Repeatable read (可重复读)：可避免脏读、不可重复读的发生。

* Read committed (读已提交)：可避免脏读的发生。

* Read uncommitted (读未提交)：最低级别，任何情况都无法保证。


* **幻读**：T1, T2两个事务同时对表进行操作。T1写入一条数据，由于两个事务同时操作一个表，T2两次读表，得到的结果不同，即为幻读。不隔离新增的数据。

* **不可重复读**：不可重复读是一个事务执行过程中，另一事务提交并修改了当前事务正在读取的数据，此时产生冲突。

    不可重复读是两个并发的事务，“事务A：消费”、“事务B：老婆网上转账”，事务A事先读取了数据，事务B紧接了更新了数据，并提交了事务，而事务A再次读取该数据时，数据已经发生了改变。

* **产生脏读**：事务执行过程中，T1发生回滚，此时T2读到的数据没有任意义。这个叫脏读。
    
    脏读是两个并发的事务，“事务A：领导发工资”、“事务B：我查询工资账户”，事务B读取了事务A尚未提交的数据。
    

### 如何保证持久性
* 成功提交的事务，数据会保存到磁盘
* 未提交的事务，相应的数据会回滚

### 事务日志
* LSN：一个按时间顺序分配的唯一日志序列号，靠后的操作的LSN比靠前的大。
* TransID：产生操作的事务ID。
* PageID：被修改的数据在磁盘上的位置，数据以页为单位存储。
* PrevLSN：同一个事务产生的上一条日志记录的指针。
* UNDO：取消本次操作的方法，按照此方法回滚。
* REDO：重复本次操作的方法，如有必要，重复此方法保证操作成功。

磁盘上每个页（保存数据的，不是保存日志的）都记录着最后一个修改该数据操作的LSN。数据库会通过解析事务日志，将修改真正落到磁盘上(写盘)，随后清理事务日志(正常情况下)。
* 将数据的变更以事务日志的方式，按照时间先后追加到日志缓冲区，由特定算法写入事务日志，这是顺序IO，性能较好
* 通过数据管理器解析事务日志，由特定的算法择机进行写盘


### 数据库恢复
当数据库从崩溃中恢复时，会有以下几个步骤,经过这几个阶段，在数据库恢复后，可以达到奔溃前的状态，也保证了数据的一致性：

1. 解析存在的事务日志，分析哪些事务需要回滚，哪些需要写盘(还没来得及写盘，数据库就崩溃了)。
2. Redo，进行写盘。检测对应数据所在数据页的LSN，如果数据页的LSN>=事务操作的LSN，说明已经写过盘，不然进行写盘操作。
3. Undo, 按照LSN倒序进行回滚


### 事务的编写
* BEGIN TRANSACTION：事务的起始点
* COMMIT TRANSACTION ：提交事务
* ROLLBACK TRANSACTION ：滚到事务的起始点或事务内的某个保存点

```sql
    --@@TRANCOUNT 函数记录当前事务的嵌套级。
    --每一次Begin Transaction都会引起@@TranCount加1。
    --而每一次Commit Transaction都会使@@TranCount减1。
    --而RollBack Transaction会回滚所有的嵌套事务包括已经提交的事务和未提交的事务，而使@@TranCount置0。
    
    BEGIN TRAN TestTran;
    
    BEGIN TRY
    INSERT INTO TranTest VALUES (1);
    INSERT INTO TranTest VALUES (NULL);
    INSERT INTO TranTest VALUES (2);
    END TRY BEGIN CATCH
    IF @@TRANCOUNT > 0 ROLLBACK TRAN TestTran;
    END CATCH
    
    IF @@TRANCOUNT > 0   
    COMMIT TRAN TestTran;
    GO
```















